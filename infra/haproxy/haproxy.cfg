global
    log stdout local0
    chroot /var/lib/haproxy
    stats socket /run/haproxy/admin.sock mode 660 level admin
    stats timeout 30s
    user haproxy
    group haproxy
    daemon

    # SSL Configuration
    tune.ssl.default-dh-param 2048
    ssl-default-bind-options ssl-min-ver TLSv1.2 no-sslv3
    ssl-default-bind-ciphers ECDHE+AESGCM:ECDHE+CHACHA20:RSA+AESGCM:RSA+AES:!aNULL:!MD5:!DSS
    ssl-default-server-options ssl-min-ver TLSv1.2 no-sslv3
    ssl-default-server-ciphers ECDHE+AESGCM:ECDHE+CHACHA20:RSA+AESGCM:RSA+AES:!aNULL:!MD5:!DSS

defaults
    mode http
    log global
    option httplog
    option dontlognull
    option log-health-checks
    option forwardfor
    option http-server-close
    timeout connect 5s
    timeout client 50s
    timeout server 50s
    timeout http-request 15s
    timeout http-keep-alive 15s

    # Error files
    errorfile 400 /etc/haproxy/errors/400.http
    errorfile 403 /etc/haproxy/errors/403.http
    errorfile 408 /etc/haproxy/errors/408.http
    errorfile 500 /etc/haproxy/errors/500.http
    errorfile 502 /etc/haproxy/errors/502.http
    errorfile 503 /etc/haproxy/errors/503.http
    errorfile 504 /etc/haproxy/errors/504.http

# HAProxy Statistics
frontend stats
    bind *:8404
    stats enable
    stats uri /stats
    stats refresh 30s
    stats admin if TRUE
    stats auth admin:${HAPROXY_STATS_PASSWORD}

# Frontend for HTTP (redirect to HTTPS)
frontend http_frontend
    bind *:80
    redirect scheme https code 301 if !{ ssl_fc }

# Frontend for HTTPS
frontend https_frontend
    bind *:443 ssl crt /etc/ssl/vetrai/vetrai.crt
    
    # Security headers
    http-response set-header Strict-Transport-Security "max-age=63072000; includeSubDomains; preload"
    http-response set-header X-Content-Type-Options "nosniff"
    http-response set-header X-Frame-Options "DENY"
    http-response set-header X-XSS-Protection "1; mode=block"
    http-response set-header Referrer-Policy "strict-origin-when-cross-origin"
    
    # Rate limiting
    stick-table type ip size 100k expire 30s store http_req_rate(10s)
    http-request track-sc0 src
    http-request reject if { sc_http_req_rate(0) gt 20 }
    
    # Route based on Host header
    acl is_studio_frontend hdr(host) -i vetrai.yourdomain.com
    acl is_admin_dashboard hdr(host) -i admin.vetrai.yourdomain.com
    acl is_api hdr(host) -i api.vetrai.yourdomain.com
    
    # Route to appropriate backend
    use_backend studio_frontend if is_studio_frontend
    use_backend admin_dashboard if is_admin_dashboard
    use_backend api_gateway if is_api
    
    # Default backend
    default_backend studio_frontend

# Studio Frontend Backend
backend studio_frontend
    balance roundrobin
    option httpchk GET /api/health
    http-check expect status 200
    
    server nginx-primary nginx-primary:80 check inter 5s fall 3 rise 2 weight 100
    server nginx-secondary nginx-secondary:80 check inter 5s fall 3 rise 2 weight 50 backup

# Admin Dashboard Backend
backend admin_dashboard
    balance roundrobin
    option httpchk GET /health
    http-check expect status 200
    
    server nginx-primary nginx-primary:80 check inter 5s fall 3 rise 2 weight 100
    server nginx-secondary nginx-secondary:80 check inter 5s fall 3 rise 2 weight 50 backup

# API Gateway Backend
backend api_gateway
    balance roundrobin
    option httpchk GET /health
    http-check expect status 200
    timeout server 300s  # Extended timeout for AI operations
    
    # API endpoint routing
    http-request set-path /api/v1/auth%[path] if { path_beg /api/v1/auth }
    http-request set-path /api/v1/tenancy%[path] if { path_beg /api/v1/tenancy }
    http-request set-path /api/v1/workers%[path] if { path_beg /api/v1/workers }
    http-request set-path /api/v1/models%[path] if { path_beg /api/v1/models }
    http-request set-path /api/v1/agents%[path] if { path_beg /api/v1/agents }
    http-request set-path /api/v1/workflows%[path] if { path_beg /api/v1/workflows }
    http-request set-path /api/v1/integrations%[path] if { path_beg /api/v1/integrations }
    http-request set-path /api/v1/analytics%[path] if { path_beg /api/v1/analytics }
    
    server nginx-primary nginx-primary:80 check inter 5s fall 3 rise 2 weight 100
    server nginx-secondary nginx-secondary:80 check inter 5s fall 3 rise 2 weight 50 backup

# Auth Service Backend (Direct access for load balancing)
backend auth_service_direct
    balance roundrobin
    option httpchk GET /health
    http-check expect status 200
    
    server auth-1 auth-service:8000 check inter 5s fall 3 rise 2 weight 100
    server auth-2 auth-service:8000 check inter 5s fall 3 rise 2 weight 100

# Workers Service Backend (Direct access for load balancing)
backend workers_service_direct
    balance roundrobin
    option httpchk GET /health
    http-check expect status 200
    timeout server 300s  # Extended timeout for AI operations
    
    server workers-1 workers-service:8000 check inter 5s fall 3 rise 2 weight 100
    server workers-2 workers-service:8000 check inter 5s fall 3 rise 2 weight 100
    server workers-3 workers-service:8000 check inter 5s fall 3 rise 2 weight 100

# Models Service Backend (Direct access for load balancing)
backend models_service_direct
    balance roundrobin
    option httpchk GET /health
    http-check expect status 200
    timeout server 120s  # Extended timeout for model operations
    
    server models-1 models-service:8000 check inter 5s fall 3 rise 2 weight 100
    server models-2 models-service:8000 check inter 5s fall 3 rise 2 weight 100

# Health Check Backend
backend health_check
    http-request return status 200 content-type text/plain string "HAProxy Healthy"